#!/usr/bin/env bash

# a script to create a the desired directory structure and filenames for DPX packages received from VFS

# load nmaahcmmfunctions into this script
SCRIPT_PATH=${0%/*}
. "${SCRIPT_PATH}/nmaahcmmfunctions"
[[ -f "${SCRIPT_PATH}/nmaahcmmfunctions" ]] || { echo "Missing '${SCRIPT_PATH}/nmaahcmmfunctions'. Exiting." ; exit 1 ;};
_setcolors # assigns colors using a function defined in nmaahcmmfunctions
_initialize_make # safe script termination process defined in nmaahcmmfunctions

### USAGE
_usage(){
    echo
    echo "$(basename "${0}")"
    echo "This application will create a the desired directory structure and filenames for DPX packages received from VFS."
    echo "The options below are optional; simply run '$(basename ${0})' if you would prefer to be prompted for each input."
    echo "Usage: $(basename ${0}) [ -d /path/to/deliver/to/ ] [ -i DPX_Object_ID ] [ -t DPX_Object_Title ] [ -r (number of reels) ] [ -c ] dpxpackage"
    echo "  -d directory (directory to deliver the resulting package to)"
    echo "  -i DPX_Object_ID (ex. 2012_79_1_54)"
    echo "  -t DPX_Object_Title (ex. Something_to_Build_On)"
    echo "  -r number (number of reels in the package, up to 3)"
    echo "  -c cleanup source files (remove all source files after script runs)"
    echo "  -h (display this help)"
    echo
    exit
}
# getopts loop
OPTIND=1
while getopts ":d:i:t:r:ch" OPT; do
    case "${OPT}" in
        d) DELIVERDIR="${OPTARG}" && _check_DELIVERDIR ;; # _check_DELIVERDIR defined in nmaahcmmfunctions
        i) DPXID="${OPTARG}" ;;
        t) TITLE="${OPTARG}" ;;
        r) REELNUMBER="${OPTARG}" ;;
        c) CLEANUPDECISION="Y" ;;
        h) _usage ;; # if the operator runs "[scriptname] -h" then the _usage text above will display in the terminal
        *) echo "Invalid option -${OPTARG}" ; _usage ;; # if the operator tries to use an option other than the ones listed above, the _usage text will display in the terminal
    esac
done
shift $(( ${OPTIND} - 1 ))

### FUNCTIONS
restructureDPX(){
    INPUT="${1}"
    
    if [[ -z "${REELNUMBER}" ]] ; then
        printf "%sPlease enter the number of reels your DPX package has: %s" "${BIWHITE}" "${COLOR_OFF}"
        read -r REELNUMBER
        echo
    fi
    if [[ -z "${DPXID}" ]] ; then
        printf "%sPlease enter DPX_Object_ID_Number with underscores:\n" "${BIWHITE}"
        printf "ex. 2015_167_10_1\n%s" "${COLOR_OFF}"
        read -r DPXID
        echo
    fi
    if [[ -z "${TITLE}" ]] ; then
        printf "%sPlease enter DPX_Object_Title with underscores:\n" "${BIWHITE}"
        printf "ex. Juke_Joint\n%s" "${COLOR_OFF}"
        read -r TITLE
        echo
    fi
    if [[ -z "${DELIVERDIR}" ]] ; then
        printf "%sPlease drag in the full path to the destination (where the new directory should be created):\n%s" "${BIWHITE}" "${COLOR_OFF}"
        read -r DELIVERDIR
        echo
    fi
    if [[ -z "${INPUT}" ]] ; then
        printf "%sPlease drag in the full path to the input directory:\n%s" "${BIWHITE}" "${COLOR_OFF}"
        read -r INPUT
        echo
    fi
    MEDIAID="${DPXID}__${TITLE}"
    OUTPUTDIR="${DELIVERDIR}/${MEDIAID}"
    mkdir "${OUTPUTDIR}"
    
    # record variables in ingest log
    _writeingestlog "DPX ID" "${DPXID}"
    _writeingestlog "TITLE" "${TITLE}"
    _writeingestlog "MEDIAID" "${MEDIAID}"
    _writeingestlog "REELS" "${REELNUMBER}"
    _writeingestlog "INPUT" "${INPUT}"
    _writeingestlog "START TIME" "$(date +%FT%T)"

    case "${REELNUMBER}" in
        1 )
            printf "%sMoving files from %s ${INPUT}\n${BIWHITE}${COLOR_OFF}"
            if [[ -d "${OUTPUTDIR}" ]] ; then
                # remove any .DS_Store files to begin
                "${SCRIPTDIR}/removeDSStore" "${OUTPUTDIR}"
                # find and move any .wav files fom $INPUT to $OUTPUTDIR
                for WAVPATH in "${INPUT}"/*WAV ; do
                    if [[ ! -d "${WAVPATH}" ]]; then
                        printf "\n\t%sNo .wav directory found.%s\n" "${BIWHITE}" "${COLOR_OFF}"
                        echo
                    else
                        while [[ -d "${WAVPATH}" ]] ; do
                            AUDPATH=("${OUTPUTDIR}/${DPXID}__${TITLE}__Audio") &&
                            printf "\n\t%sFound .wav directory ${WAVPATH}.\n\tRenaming to:\n\t%s%s\n" "${BIWHITE}" "${AUDPATH}" "${COLOR_OFF}" &&
                            mv -i "${WAVPATH}" "${AUDPATH}"
                        done
                    fi
                done
                # find and move and .mov files from $INPUT to $OUTPUTDIR
                for MOVPATH in "${INPUT}"/*MOV ; do
                    if [[ ! -d "${MOVPATH}" ]] ; then
                        printf "\n\t%sNo .mov directory found.%s\n" "${BIWHITE}" "${COLOR_OFF}"
                        echo
                    else
                        while [[ -d "${MOVPATH}" ]] ; do
                            DER=("${OUTPUTDIR}/${DPXID}__${TITLE}__Derivatives") &&
                            printf "\n\t%sFound .mov directory ${MOVPATH}.\n\tRenaming to:\n\t%s%s\n" "${BIWHITE}" "${DER}" "${COLOR_OFF}" &&
                            mv -i "${MOVPATH}" "${DER}"
                        done
                    fi
                done
                # move DPX directory from $input to $OUTPUTDIR and rename
                for DPXPATH in "${INPUT}"/*DPX ; do
                    if [[ ! -d "${DPXPATH}" ]] ; then
                        printf "\n\t%sNo DPX directory found.%s\n" "${BIWHITE}" "${COLOR_OFF}"
                        echo
                    else
                        while [[ -d "${DPXPATH}" ]] ; do
                            DPX=("${OUTPUTDIR}/${DPXID}__${TITLE}__DPX") &&
                            printf "\n\t%sFound DPX directory ${DPXPATH}.\n\tRenaming to:\n\t%s%s\n" "${BIWHITE}" "${DPX}" "${COLOR_OFF}" &&
                            mv -i "${DPXPATH}" "${DPX}"
                            echo
                        done
                    fi
                done
            else
                printf "%sMissing%s %s" "${BIRED}" "${COLOR_OFF}" "${OUTPUTDIR}"
                exit 1
            fi
            # find the .wav and .mov files and rename them according to NMAAHC naming structures. Finds files based on filenaming + extension; assumes each file will have descriptive filename + lowercase extension.
            printf "\n%sRenaming files in %s%s\n" "${BIWHITE}" "${COLOR_OFF}" "${OUTPUTDIR}"
            echo
            if [[ -d "${AUDPATH}" ]] ; then
                find "${AUDPATH}" -name "*.wav" -exec mv -i "{}" "${AUDPATH}/${DPXID}_AUD.wav" \;
                wav="${AUDPATH}/${DPXID}_AUD.wav"
                printf "\n\t%sRenamed audio file to %s%s\n" "${BIWHITE}" "${wav}" "${COLOR_OFF}"
            fi
            if [[ -d "${DER}" ]] ; then
                find "${DER}" -name "*ProRes*.mov" -exec mv -i "{}" "${DER}/${DPXID}_DER_01.mov" \;
                der1="${DER}/${DPXID}_DER_01.mov"
                printf "\n\t%sRenamed ProRes file to %s%s\n" "${BIWHITE}" "${der1}" "${COLOR_OFF}"
                fi
            if [[ -d "${DER}" ]] ; then
                find "${DER}" -name "*Uncompressed.mov" -exec mv -i "{}" "${DER}/${DPXID}_DER_02.mov" \;
                der2="${DER}/${DPXID}_DER_02.mov"
                printf "\n\t%sRenamed uncompressed file to %s%s\n" "${BIWHITE}" "${der2}" "${COLOR_OFF}"
                echo
            fi
            ;;

        2 )
            # make separate subdirectories for R1 and R2, with further subdirectories for the different components
            R1=("${OUTPUTDIR}/${MEDIAID}_R1")
            AUD_R1="${R1}/${MEDIAID}_R1__Audio"
            DER_R1="${R1}/${MEDIAID}_R1__Derivatives"
            dpxR1="${R1}/${MEDIAID}_R1__DPX"
            R2=("${OUTPUTDIR}/${MEDIAID}_R2")
            AUD_R2="${R2}/${MEDIAID}_R2__Audio"
            DER_R2="${R2}/${MEDIAID}_R2__Derivatives"
            dpxR2="${R2}/${MEDIAID}_R2__DPX"
        
            mkdir -p "${R1}" "${AUD_R1}" "${DER_R1}" "${dpxR1}" "${R2}" "${AUD_R2}" "${DER_R2}" "${dpxR2}"
        
            echo
            printf "%sMoving files from%s %s" "${BIWHITE}" "${COLOR_OFF}" "${INPUT}"

            # find and move audio, derivatives, and DPX files for each reel in turn. Finds files based on filenaming + extension; assumes each file will have reel # in filename + lowercase extension.
            if [[ -d "${AUD_R1}" ]] ; then
                find "${INPUT}" -name "*R1*.wav" -exec rsync -av {} "${AUD_R1}" \;
            else
                printf "%sMissing ${AUD_R1}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            if [[ -d "${DER_R1}" ]] ; then
                find "${INPUT}" -name "*R1*.mov" -exec rsync -av {} "${DER_R1}" \;
            else
                printf "%sMissing ${DER_R1}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            if [[ -d "${dpxR1}" ]] ; then
                find "${INPUT}" -name "*R1*.dpx" -exec rsync -av {} "${dpxR1}" \;
            else
                printf "%sMissing ${dpxR1}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi

            if [[ -d "${AUD_R2}" ]] ; then
                find "${INPUT}" -name "*R2*.wav" -exec rsync -av {} "${AUD_R2}" \;
            else
                printf "%sMissing ${AUD_R2}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            if [[ -d "${DER_R2}" ]] ; then
                find "${INPUT}" -name "*R2*.mov" -exec rsync -av {} "${DER_R2}" \;
            else
                printf "%sMissing ${DER_R2}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            if [[ -d "${dpxR2}" ]] ; then
                find "${INPUT}" -name "*R2*.dpx" -exec rsync -av {} "${dpxR2}" \;
            else
                printf "%sMissing ${dpxR2}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi

            echo
            # rename files according to NMAAHC filenaming guidelines
            printf "%sRenaming files in %s%s\n" "${BIWHITE}" "${COLOR_OFF}" "${OUTPUTDIR}"
            find "${AUD_R1}" -name "*R1*.wav" -exec mv -vi {} "${AUD_R1}/${DPXID}_R1_AUD.wav" \;
            find "${DER_R1}" -name "*R1*ProRes*.mov" -exec mv -vi {} "${DER_R1}/${DPXID}_R1_DER_01.mov" \;
            find "${DER_R1}" -name "*R1*Uncompressed*.mov" -exec mv -vi {} "${DER_R1}/${DPXID}_R1_DER_02.mov" \;
            find "${AUD_R2}" -name "*R2*.wav" -exec mv -vi {} "${AUD_R2}/${DPXID}_R2_AUD.wav" \;
            find "${DER_R2}" -name "*R2*ProRes*.mov" -exec mv -vi {} "${DER_R2}/${DPXID}_R2_DER_01.mov" \;
            find "${DER_R2}" -name "*R2*Uncompressed*.mov" -exec mv -vi {} "${DER_R2}/${DPXID}_R2_DER_02.mov" \;
            ;;

        3 )
            # make separate subdirectories for R1, R2, and R3, with further subdirectories for the different components
            R1=("${OUTPUTDIR}/${MEDIAID}_R1")
            AUD_R1="${R1}/${MEDIAID}_R1__Audio"
            DER_R1="${R1}/${MEDIAID}_R1__Derivatives"
            dpxR1="${R1}/${MEDIAID}_R1__DPX"
            R2=("${OUTPUTDIR}/${MEDIAID}_R2")
            AUD_R2="${R2}/${MEDIAID}_R2__Audio"
            DER_R2="${R2}/${MEDIAID}_R2__Derivatives"
            dpxR2="${R2}/${MEDIAID}_R2__DPX"
            R3=("${OUTPUTDIR}/${MEDIAID}_R3")
            AUD_R3="${R3}/${MEDIAID}_R3__Audio"
            DER_R3="${R3}/${MEDIAID}_R3__Derivatives"
            dpxR3="${R3}/${MEDIAID}_R3__DPX"
            mkdir -p "${R1}" "${AUD_R1}" "${DER_R1}" "${dpxR1}" "${R2}" "${AUD_R2}" "${DER_R2}" "${dpxR2}" "${R3}" "${AUD_R3}" "${DER_R3}" "${dpxR3}"
            echo
            printf "%sMoving files from%s %s" "${BIWHITE}" "${COLOR_OFF}" "${INPUT}"

            # find and move audio, derivatives, and DPX files for each reel in turn. Finds files based on filenaming + extension; assumes each file will have reel # in filename + lowercase extension.
            if [[ -d "${AUD_R1}" ]] ; then
                find "${INPUT}" -name "*R1*.wav" -exec rsync -av {} "${AUD_R1}" \;
            else
                printf "%sMissing ${AUD_R1}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            if [[ -d "${DER_R1}" ]] ; then
                find "${INPUT}" -name "*R1*.mov" -exec rsync -av {} "${DER_R1}" \;
            else
                printf "%sMissing ${DER_R1}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            if [[ -d "${dpxR1}" ]] ; then
                find "${INPUT}" -name "*R1*.dpx" -exec rsync -av {} "${dpxR1}" \;
            else
                printf "%sMissing ${dpxR1}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi

            if [[ -d "${AUD_R2}" ]] ; then
                find "${INPUT}" -name "*R2*.wav" -exec rsync -av {} "${AUD_R2}" \;
            else
                printf "%sMissing ${AUD_R2}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            if [[ -d "${DER_R2}" ]] ; then
                find "${INPUT}" -name "*R2*.mov" -exec rsync -av {} "${DER_R2}" \;
            else
                printf "%sMissing ${DER_R2}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            if [[ -d "${dpxR2}" ]] ; then
                find "${INPUT}" -name "*R2*.dpx" -exec rsync -av {} "${dpxR2}" \;
            else
                printf "%sMissing ${dpxR2}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi

            if [[ -d "${AUD_R3}" ]] ; then
                find "${INPUT}" -name "*R3*.wav" -exec rsync -av {} "${AUD_R3}" \;
            else
                printf "%sMissing ${AUD_R3}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            if [[ -d "${DER_R3}" ]] ; then
                find "${INPUT}" -name "*R3*.mov" -exec rsync -av {} "${DER_R3}" \;
            else
                printf "%sMissing ${DER_R3}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            if [[ -d "${dpxR3}" ]] ; then
                find "${INPUT}" -name "*R3*.dpx" -exec rsync -av {} "${dpxR3}" \;
            else
                printf "%sMissing ${dpxR3}%s" "${BIRED}" "${COLOR_OFF}"
                exit 1
            fi
            echo
            # rename files according to NMAAHC filenaming guidelines
            printf "%sRenaming files in %s%s\n" "${BIWHITE}" "${COLOR_OFF}" "${OUTPUTDIR}"
            find "${AUD_R1}" -name "*R1*.wav" -exec mv -vi {} "${AUD_R1}/${DPXID}_R1_AUD.wav" \;
            find "${DER_R1}" -name "*R1*ProRes*.mov" -exec mv -vi {} "${DER_R1}/${DPXID}_R1_DER_01.mov" \;
            find "${DER_R1}" -name "*R1*Uncompressed*.mov" -exec mv -vi {} "${DER_R1}/${DPXID}_R1_DER_02.mov" \;
            find "${AUD_R2}" -name "*R2*.wav" -exec mv -vi {} "${AUD_R2}/${DPXID}_R2_AUD.wav" \;
            find "${DER_R2}" -name "*R2*ProRes*.mov" -exec mv -vi {} "${DER_R2}/${DPXID}_R2_DER_01.mov" \;
            find "${DER_R2}" -name "*R2*Uncompressed*.mov" -exec mv -vi {} "${DER_R2}/${DPXID}_R2_DER_02.mov" \;
            find "${AUD_R3}" -name "*R3*.wav" -exec mv -vi {} "${AUD_R3}/${DPXID}_R3_AUD.wav" \;
            find "${DER_R3}" -name "*R3*ProRes*.mov" -exec mv -vi {} "${DER_R3}/${DPXID}_R3_DER_01.mov" \;
            find "${DER_R3}" -name "*R3*Uncompressed*.mov" -exec mv -vi {} "${DER_R3}/${DPXID}_R3_DER_02.mov" \;
            ;;

            *   )
            printf "%sERROR. Presently, this script can only handle DPX packages of 1 or 2 or 3 reels. Check back later." "${BIRED}"
            _log -w "Attempt to run restructureDPX with >3 reels in package."
            echo
            cowsay "SORRY!"
            ;;
    esac
}

## SCRIPT ACTIONS

# log script beginning
_log -b
restructureDPX "${@}"
if [[ -z "${CLEANUPDECISION}" ]] ; then
    printf "${BIWHITE}Remove input directory? Type Y or y for yes, any other key for no: ${COLOR_OFF}\n"
    read CLEANUPDECISION
fi
if [[ "${CLEANUPDECISION}" == "Y" ]] || [[ "${CLEANUPDECISION}" == "y" ]] ; then
    rm -vr "${INPUT}" # remove input directory. -v=verbose, -r=recursive
fi
# log script ending
_log -e
_writeingestlog "END TIME" "$(date +%FT%T)"
printf "${BIWHITE}restructureDPX process complete.${COLOR_OFF}\n"
exit $?
