#!/usr/bin/env bash

#a script to create md5 checksums of all files in a directory or a single file and save it to a .md5 file

### CONSTANTS

biwhite=$(tput bold)$(tput setaf 7)
#bired=$(tput bold)$(tput setaf 1)
color_off=$(tput sgr0)
date="$(date +%Y%m%d)"

### FUNCTIONS

makechecksum ()

{
echo
while [[ $# -gt 0 ]] ; do

	input="$1" #name $input as the first arugment sent to script

	if [ -d "$input" ] ; then 	#if argment is a directory, run md5deep
	  target="${input%/}" #strip the trailing /, if any
		echo "target is $target"
	  target="${target##*/}" #drop the leading directory componenets i.e. get basename
		echo "target is $target"
	  output="$input"/"$target"_"$date"_checksums.md5 #set .md5 file to $output
	  printf "%s%s%s is a directory.\n" "$biwhite" "$target" "$color_off"
	  printf "Making checksums of all files in %s\n" "$biwhite$target$color_off"
	  printf "Writing to %s\n" "$biwhite$output$color_off"
	  md5deep -bre "$input" >> "$output" #create md5 hash (hashes) of $input and write results to $output
	fi

	if [ -f "$input" ] ; then #if argment is a file, run md5deep
		target="${input##*/}" #get basname of $input
		target="${target%.*}" #strip extention from $target
		output="${input%/*}" #get full path parent dirname of $input
		output="$output"/"$target"_"$date"_checksums.md5 #set .md5 file to $output
		printf "%s%s%s is a file.\n" "$biwhite" "${input##*/}" "$color_off"
		printf "Making checksum of %s%s%s\n" "$biwhite" "${input##*/}" "$color_off"
		printf "Writing to %s\n" "$biwhite$output$color_off"
		md5deep -bre "$input" >> "$output" #create md5 hash (hashes) of $input and write results to $output
	fi

	echo
	printf "Sorting %s%s%s\n" "$biwhite" "${output##*/}" "$color_off" #sort $output
	sort -k 2 -o "$output" "$output"
	shift
	echo
		if [[ $# -gt 0 ]] ; then
			printf "Finished making checksums for %s%s%s.\n\n<>..<> Moving to %s%s%s\n" "$biwhite" "${input##*/}" "$color_off" "$biwhite" "${1##*/}" "$color_off"
			echo
		else
			printf "Finished making checksums for %s%s%s.\nNothing left to checksum.\n" "$biwhite" "${input##*/}" "$color_off"
			echo
			cowsay "Tootles!"
		fi

done
}

#call the function(s)

makechecksum "$@"

exit $?
